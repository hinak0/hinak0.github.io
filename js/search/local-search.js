class LocalSearch{constructor({path:e="",unescape:t=false,top_n_per_article:n=1}){this.path=e;this.unescape=t;this.top_n_per_article=n;this.isfetched=false;this.datas=null}getIndexByWord(e,t,n=false){const i=[];const a=new Set;if(!n){t=t.toLowerCase()}e.forEach(e=>{if(this.unescape){const t=document.createElement("div");t.innerText=e;e=t.innerHTML}const s=e.length;if(s===0)return;let l=0;let o=-1;if(!n){e=e.toLowerCase()}while((o=t.indexOf(e,l))>-1){i.push({position:o,word:e});a.add(e);l=o+s}});i.sort((e,t)=>{if(e.position!==t.position){return e.position-t.position}return t.word.length-e.word.length});return[i,a]}mergeIntoSlice(e,t,n){let i=n[0];let{position:a,word:s}=i;const l=[];const o=new Set;while(a+s.length<=t&&n.length!==0){o.add(s);l.push({position:a,length:s.length});const e=a+s.length;n.shift();while(n.length!==0){i=n[0];a=i.position;s=i.word;if(e>a){n.shift()}else{break}}}return{hits:l,start:e,end:t,count:o.size}}highlightKeyword(e,t){let n="";let i=t.start;for(const{position:a,length:s}of t.hits){n+=e.substring(i,a);i=a+s;n+=`<mark class="search-keyword">${e.substr(a,s)}</mark>`}n+=e.substring(i,t.end);return n}getResultItems(e){const t=[];this.datas.forEach(({title:n,content:i,url:a})=>{const[s,l]=this.getIndexByWord(e,n);const[o,r]=this.getIndexByWord(e,i);const c=new Set([...l,...r]).size;const h=s.length+o.length;if(h===0)return;const d=[];if(s.length!==0){d.push(this.mergeIntoSlice(0,n.length,s))}let g=[];while(o.length!==0){const e=o[0];const{position:t}=e;const n=Math.max(0,t-20);const a=Math.min(i.length,t+100);g.push(this.mergeIntoSlice(n,a,o))}g.sort((e,t)=>{if(e.count!==t.count){return t.count-e.count}else if(e.hits.length!==t.hits.length){return t.hits.length-e.hits.length}return e.start-t.start});const u=parseInt(this.top_n_per_article,10);if(u>=0){g=g.slice(0,u)}let p="";a=new URL(a,location.origin);a.searchParams.append("highlight",e.join(" "));if(d.length!==0){p+=`<li class="local-search-hit-item"><a href="${a.href}"><span class="search-result-title">${this.highlightKeyword(n,d[0])}</span>`}else{p+=`<li class="local-search-hit-item"><a href="${a.href}"><span class="search-result-title">${n}</span>`}g.forEach(e=>{p+=`<p class="search-result">${this.highlightKeyword(i,e)}...</p>`});p+="</a></li>";t.push({item:p,id:t.length,hitCount:h,includedCount:c})});return t}fetchData(){const e=!this.path.endsWith("json");fetch(this.path).then(e=>e.text()).then(t=>{this.isfetched=true;this.datas=e?[...(new DOMParser).parseFromString(t,"text/xml").querySelectorAll("entry")].map(e=>({title:e.querySelector("title").textContent,content:e.querySelector("content").textContent,url:e.querySelector("url").textContent})):JSON.parse(t);this.datas=this.datas.filter(e=>e.title).map(e=>{e.title=e.title.trim();e.content=e.content?e.content.trim().replace(/<[^>]+>/g,""):"";e.url=decodeURIComponent(e.url).replace(/\/{2,}/g,"/");return e});window.dispatchEvent(new Event("search:loaded"))})}highlightText(e,t,n){const i=e.nodeValue;let a=t.start;const s=[];for(const{position:e,length:l}of t.hits){const t=document.createTextNode(i.substring(a,e));a=e+l;const o=document.createElement("mark");o.className=n;o.appendChild(document.createTextNode(i.substr(e,l)));s.push(t,o)}e.nodeValue=i.substring(a,t.end);s.forEach(t=>{e.parentNode.insertBefore(t,e)})}highlightSearchWords(e){const t=new URL(location.href).searchParams.get("highlight");const n=t?t.split(" "):[];if(!n.length||!e)return;const i=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null);const a=[];while(i.nextNode()){if(!i.currentNode.parentNode.matches("button, select, textarea, .mermaid"))a.push(i.currentNode)}a.forEach(e=>{const[t]=this.getIndexByWord(n,e.nodeValue);if(!t.length)return;const i=this.mergeIntoSlice(0,e.nodeValue.length,t);this.highlightText(e,i,"search-keyword")})}}window.addEventListener("load",()=>{const{path:e,top_n_per_article:t,unescape:n,languages:i,pagination:a}=GLOBAL_CONFIG.localSearch;const s=a&&a.enable;const l=new LocalSearch({path:e,top_n_per_article:t,unescape:n});const o=document.querySelector(".local-search-input input");const r=document.getElementById("local-search-stats");const c=document.getElementById("loading-status");const h=!e.endsWith("json");let d=0;const g=a.hitsPerPage||10;let u=[];if(!s){d=undefined;u=undefined}const p={get pagination(){return document.getElementById("local-search-pagination")},get paginationList(){return document.querySelector("#local-search-pagination .ais-Pagination-list")}};const f=e=>{if(s){p.pagination.style.display=e?"":"none"}else{p.pagination.style.display="none"}};const m=(e,t)=>{const n=document.getElementById("local-search-results");const a=s?u.slice(d*g,(d+1)*g):t;if(s&&a.length===0&&u.length>0){d=0;m(e,t);return}const l=a.map((e,t)=>{const n=s?d*g+t+1:t+1;return e.item.replace('<li class="local-search-hit-item">',`<li class="local-search-hit-item" value="${n}">`)});n.innerHTML=`<ol class="search-result-list">${l.join("")}</ol>`;const o=s?u.length:t.length;const c=i.hits_stats.replace(/\$\{hits}/,o);r.innerHTML=`<hr><div class="search-result-stats">${c}</div>`;if(s){const t=Math.ceil(u.length/g);w(d,t,e)}const h=t.length>0;f(h);window.pjax&&window.pjax.refresh(n)};const w=(e,t,n)=>{if(t<=1){p.pagination.style.display="none";p.paginationList.innerHTML="";return}p.pagination.style.display="block";const i=e===0;const a=e===t-1;const s=window.innerWidth<768;const l=s?3:5;let o=Math.max(0,e-Math.floor(l/2));const r=Math.min(t-1,o+l-1);if(r-o+1<l){o=Math.max(0,r-l+1)}let c="";if(t>l&&o>0){c+=`\n        <li class="ais-Pagination-item ais-Pagination-item--page">\n          <a class="ais-Pagination-link" aria-label="Page 1" href="#" data-page="0">1</a>\n        </li>`;if(o>1){c+=`\n          <li class="ais-Pagination-item ais-Pagination-item--ellipsis">\n            <span class="ais-Pagination-link">...</span>\n          </li>`}}for(let t=o;t<=r;t++){const n=t===e;if(n){c+=`\n          <li class="ais-Pagination-item ais-Pagination-item--page ais-Pagination-item--selected">\n            <span class="ais-Pagination-link" aria-label="Page ${t+1}">${t+1}</span>\n          </li>`}else{c+=`\n          <li class="ais-Pagination-item ais-Pagination-item--page">\n            <a class="ais-Pagination-link" aria-label="Page ${t+1}" href="#" data-page="${t}">${t+1}</a>\n          </li>`}}if(t>l&&r<t-1){if(r<t-2){c+=`\n          <li class="ais-Pagination-item ais-Pagination-item--ellipsis">\n            <span class="ais-Pagination-link">...</span>\n          </li>`}c+=`\n        <li class="ais-Pagination-item ais-Pagination-item--page">\n          <a class="ais-Pagination-link" aria-label="Page ${t}" href="#" data-page="${t-1}">${t}</a>\n        </li>`}if(t>1){p.paginationList.innerHTML=`\n            <li class="ais-Pagination-item ais-Pagination-item--previousPage ${i?"ais-Pagination-item--disabled":""}">\n              ${i?'<span class="ais-Pagination-link ais-Pagination-link--disabled" aria-label="Previous Page"><i class="fas fa-angle-left"></i></span>':`<a class="ais-Pagination-link" aria-label="Previous Page" href="#" data-page="${e-1}"><i class="fas fa-angle-left"></i></a>`}\n            </li>\n            ${c}\n            <li class="ais-Pagination-item ais-Pagination-item--nextPage ${a?"ais-Pagination-item--disabled":""}">\n              ${a?'<span class="ais-Pagination-link ais-Pagination-link--disabled" aria-label="Next Page"><i class="fas fa-angle-right"></i></span>':`<a class="ais-Pagination-link" aria-label="Next Page" href="#" data-page="${e+1}"><i class="fas fa-angle-right"></i></a>`}\n            </li>`}else{p.pagination.style.display="none"}};const P=()=>{const e=document.getElementById("local-search-results");e.textContent="";r.textContent="";f(false);if(s){u=[];d=0}};const y=e=>{const t=document.getElementById("local-search-results");t.textContent="";const n=document.createElement("div");n.className="search-result-stats";n.textContent=i.hits_empty.replace(/\$\{query}/,e);r.innerHTML=n.outerHTML;f(false);if(s){u=[];d=0}};const b=()=>{if(!l.isfetched)return;let e=o.value.trim().toLowerCase();h&&(e=e.replace(/</g,"&lt;").replace(/>/g,"&gt;"));if(e!=="")c.hidden=false;const t=e.split(/[-\s]+/);let n=[];if(e.length>0){n=l.getResultItems(t)}if(t.length===1&&t[0]===""){P()}else if(n.length===0){y(e)}else{n.sort((e,t)=>{if(e.includedCount!==t.includedCount){return t.includedCount-e.includedCount}else if(e.hitCount!==t.hitCount){return t.hitCount-e.hitCount}return t.id-e.id});if(s){u=n;d=0}m(e,n)}c.hidden=true};let E=false;const x=document.getElementById("search-mask");const L=document.querySelector("#local-search .search-dialog");const v=()=>{if(window.innerWidth<768){L.style.setProperty("--search-height",window.innerHeight+"px")}};const S=()=>{btf.overflowPaddingR.add();btf.animateIn(x,"to_show 0.5s");btf.animateIn(L,"titleScale 0.5s");setTimeout(()=>{o.focus()},300);if(!E){!l.isfetched&&l.fetchData();o.addEventListener("input",b);E=true}document.addEventListener("keydown",function e(t){if(t.code==="Escape"){k();document.removeEventListener("keydown",e)}});v();window.addEventListener("resize",v)};const k=()=>{btf.overflowPaddingR.remove();btf.animateOut(L,"search_close .5s");btf.animateOut(x,"to_hide 0.5s");window.removeEventListener("resize",v)};const I=()=>{btf.addEventListenerPjax(document.querySelector("#search-button > .search"),"click",S)};const $=()=>{document.querySelector("#local-search .search-close-button").addEventListener("click",k);x.addEventListener("click",k);if(GLOBAL_CONFIG.localSearch.preload){l.fetchData()}l.highlightSearchWords(document.getElementById("article-container"));if(s){p.pagination.addEventListener("click",e=>{e.preventDefault();const t=e.target.closest("a[data-page]");if(t){const e=parseInt(t.dataset.page,10);if(!isNaN(e)&&u.length>0){d=e;m(o.value.trim().toLowerCase(),u)}}})}f(false)};window.addEventListener("search:loaded",()=>{const e=document.getElementById("loading-database");e.nextElementSibling.style.visibility="visible";e.remove()});I();$();window.addEventListener("pjax:complete",()=>{!btf.isHidden(x)&&k();l.highlightSearchWords(document.getElementById("article-container"));I()})});
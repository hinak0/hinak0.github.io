---
title: 旁路由配置
date: 2022-10-07
categories:
  - 网络工程
---

## 什么是旁路由

将传统的 终端-路由模式 改为 终端-网关-路由模式 ，数据经过网关的代理，再发送给路由器。

## 我为什么使用旁路由

我的软路由无法连接到宿舍的校园网，并非无法获取ip，而是爱快系统的某些配置导致即使网卡的mac已经经过了校园网的认证(通过其他设备更改mac认证实现)，仍然无法链接上网络。而虚拟机的openwrt系统就能正常上网，推测是爱快的线路检测机制（设置静态路由表也不好使）。

也许可以让爱快使用openwrt的网络？但是这实在算不上优雅。

现在宿舍网络采用的是小米路由器连接校园网作为主路由，软路由当作旁路网关的一个结构。

## 我的旁路由如何配置

首先在openwrt上只配置一个lan口，网关配置为主路由，然后ssr允许lan口连接配置。

然后在爱快上配置dhcp服务，爱快的dhcp管理真的很好用，可以为每个设备配置单独的网关和dns。记得给openwrt分配一个固定的ip，然后给需要留学的设备设置网关为openwrt.

最后最好关掉小米路由器的dhcp服务。

## 为什么要配置防火墙

在配置完成后，我发现一个问题，电脑网络一切正常，安卓机却只能留学不能访问国内网站（很慢），遂百度之，发现可能是路由器或者安卓的防劫持机制。鉴于电脑正常，我估计是安卓的机制。简单来说就是安卓发送数据的网关是openwrt，却收到了主路由返回的包，认为被劫持了，就不要这个数据包。

这个帖子讲的比较清楚：[关于N1做旁路由添加 iptables 自定义防火墙规则的见解](https://www.right.com.cn/forum/thread-2983767-1-1.html)。

也就是让旁路网关把数据包源ip改成自己的，再发送出去，这样回复包也会先给网关，再由网关返回终端设备，就不会触发防劫持，也能使去广告等插件正常工作。

不过这样带来一次ip转换，性能会有微小损失，但是这不是我30m校园网该考虑的事。

![](images/9bc343.png)

增加了一个跳数

下一步打算给软路由刷个linux当服务器使，爱快没有root权限实在很限制手脚。

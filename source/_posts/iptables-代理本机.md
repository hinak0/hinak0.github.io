---
title: "IPtables 代理本机"
date: "2022-12-13"
categories:
  - "网络工程"
---

iptables规则:

```
# Generated by iptables-save v1.8.7 on Tue Dec 13 13:10:11 2022
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
COMMIT
# Completed on Tue Dec 13 13:10:11 2022
# Generated by iptables-save v1.8.7 on Tue Dec 13 13:10:11 2022
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
-A PREROUTING -s 192.168.1.0/24 -p udp -m udp --dport 53 -j REDIRECT --to-ports 5354
-A PREROUTING -s 192.168.1.0/24 -d 192.168.1.0/24 -p tcp -j RETURN
-A PREROUTING -s 192.168.1.0/24 -p tcp -j REDIRECT --to-ports 7892
-A OUTPUT -d 127.0.0.0/8 -j RETURN
-A OUTPUT -d 192.168.1.0/24 -j RETURN
-A OUTPUT -m mark --mark 6666 -j RETURN
-A OUTPUT -p tcp -j REDIRECT --to-ports 7892
-A OUTPUT -p udp -m udp --dport 53 -j REDIRECT --to-ports 5354
COMMIT
# Completed on Tue Dec 13 13:10:11 2022
```

clash配置:

```
routing-mark: 6666
```

完整配置:

```
port: 7890
socks-port: 7891
redir-port: 7892
allow-lan: true
routing-mark: 6666
mode: Rule
log-level: info
ipv6: false
external-controller: :8080
external-ui: dist
hosts:
  'hinak0': 192.168.1.2
  'miui': 192.168.1.3
  'lenovo': 192.168.1.5
profile:
  # Store the `select` results in $HOME/.config/clash/.cache
  # set false If you don't want this behavior
  # when two different configurations have groups with the same name, the selected values are shared
  store-selected: false

  # persistence fakeip
  store-fake-ip: true
dns:
  enable: true
  ipv6: false
  listen: 0.0.0.0:5354
  enhanced-mode: redir-host       # redir-host or fake-ip
  # fake-ip-range: 198.18.0.1/16    # Fake IP addresses pool CIDR
  use-hosts: true                 # lookup hosts and return IP record
  nameserver:
    - 114.114.114.114      # DNSpod DNS
    - 223.5.5.5         # 阿里
  # 提供 fallback 时，如果GEOIP非 CN 中国时使用 fallback 解析
  fallback:
    - tls://8.8.8.8:853         # Google DNS over TLS 50ms
    - tls://8.8.4.4:853         # cloudflare DNS over TLS 50ms
    - https://1.1.1.1/dns-query # cloudflare DNS over HTTPS
    - https://dns.google/dns-query # Google DNS over HTTPS
  # 强制DNS解析使用`fallback`配置
  fallback-filter:
    # true: CN使用nameserver解析，非CN使用fallback
    geoip: true
```
